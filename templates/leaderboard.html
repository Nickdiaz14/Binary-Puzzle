<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=0.9, user-scale=no, maximum-scale=0.9">
        <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/styles.css') }}">
        <title>Leaderboards</title>
    </head>
    <body>
        <div class="js-container container" style="top:0px !important;">
            <div style="text-align:center; margin: 20px;">
                <span id="title" style="font-size: 30px; font-weight: bold; color: #ffffff;">Ranking de {{board}}</span>
            </div>
            <label for="matrix-size" style="font-size: 22px; color: #ffffff; font-weight: bold; margin-top: 10px; margin-bottom: 10px">{{ message }}</label>
            <div id="leaderboard" style="text-align: center;margin-top: 20px;"></div>
            <div style="text-align:center;" class="botones">
                <button onclick="reintentar()" class="resolver evaluar">Reintentar</button>
                <button onclick="location.href=`/menu?userID=${localStorage.getItem('userId')}`" class= "resolver evaluar">Volver</button>
            </div>
        </div>
        <script>
            function reintentar() {
                if (board === "Contrareloj") {
                    window.location.href = '/time_trial'
                }else {
                    window.location.href = '/play'
                }
            }
            const best = '{{best}}'
            const Confettiful = function (el) {
                this.el = el;
                this.containerEl = null;
                this.confettiFrequency = 3;
                this.confettiColors = ['#00ff04', '#ff0000', '#ff00e6', '#00a2ff','#ffea00'];
                this.confettiAnimations = ['slow', 'medium', 'fast'];
                this._setupElements();
                this._renderConfetti();
            };

            Confettiful.prototype._setupElements = function () {
                const containerEl = document.createElement('div');
                containerEl.classList.add('confetti-container');
                this.el.style.position = 'relative';
                this.el.appendChild(containerEl);
                this.containerEl = containerEl;
            };

            Confettiful.prototype._renderConfetti = function () {
                this.confettiInterval = setInterval(() => {
                    const confettiEl = document.createElement('div');
                    const confettiSize = `${Math.floor(Math.random() * 8) + 7}px`;
                    const confettiBackground = this.confettiColors[Math.floor(Math.random() * this.confettiColors.length)];
                    const confettiLeft = `${Math.random() * this.el.offsetWidth}px`;
                    const confettiAnimation = this.confettiAnimations[Math.floor(Math.random() * this.confettiAnimations.length)];

                    confettiEl.classList.add('confetti', `confetti--animation-${confettiAnimation}`);
                    confettiEl.style.left = confettiLeft;
                    confettiEl.style.width = confettiSize;
                    confettiEl.style.height = confettiSize;
                    confettiEl.style.backgroundColor = confettiBackground;

                    this.containerEl.appendChild(confettiEl);

                    setTimeout(() => {
                        confettiEl.remove();
                    }, 3000);
                }, 25);

                // Detener la animación después de 10 segundos
                setTimeout(() => {
                    clearInterval(this.confettiInterval);
                }, 7000);
            };

            window.addEventListener('DOMContentLoaded', () => {
                const container = document.querySelector('.js-container');
                if(best === "True") {
                    new Confettiful(container);
                }
            });
            // Obtener los datos del leaderboard pasado desde el backend
            const data = JSON.parse('{{ data | safe }}');
    
            // Crear encabezados de la tabla
            let leaderboardDiv = document.getElementById('leaderboard');
            leaderboardDiv.innerHTML = '';
            let table = document.createElement('table');
            table.innerHTML = `
                <tr>
                    <th>Posición</th>
                    <th>Nombre</th>
                    <th>Record</th>
                </tr>
            `;
    
            // Mostrar las entradas del leaderboard
            data.slice(0, 5).forEach((entry, index) => {
                let row = document.createElement('tr');
                // Aplicar clase de color según la posición
                let colorClass = "";
                if (index === 0) colorClass = "#f1c40f"; // Primer lugar
                else if (index === 1) colorClass = "#7bafb9"; // Segundo lugar
                else if (index === 2) colorClass = "#bd6104"; // Tercer lugar

                row.innerHTML = `
                    <td class="tipo2" style="color: ${colorClass}">${index + 1}</td>
                    <td class="tipo2" style="color: ${colorClass}">${entry[0]}</td>
                    <td class="tipo2" style="color: ${colorClass}">${entry[1]}</td>
                `;
                table.appendChild(row);
            });
    
            leaderboardDiv.appendChild(table);

            const userIndex = data.findIndex(entry => entry[2] === localStorage.getItem('userId'));

            if (userIndex !== -1 && userIndex >= 5) { // Si el usuario está en la lista
                // Espacio entre tabla y nueva sección
                let space = document.createElement('div');
                space.style.marginTop = "30px";
                leaderboardDiv.appendChild(space);

                // Crear una nueva fila con tres celdas separadas
                let extraTable = document.createElement('table');
                extraTable.style.width = table.offsetWidth + 'px'
        
                // Crear encabezados de la tabla
                extraTable.innerHTML = `
                    <tr>
                        <th>Posición</th>
                        <th>Nombre</th>
                        <th>Record</th>
                    </tr>
                `;
                let extraRow = document.createElement('tr');
                extraRow.innerHTML = `
                    <td class="tipo2">${userIndex + 1}</td>
                    <td class="tipo2">${data[userIndex][0]}</td>
                    <td class="tipo2">${data[userIndex][1]}</td>
                `;
                extraTable.appendChild(extraRow);
                leaderboardDiv.appendChild(extraTable);
            }
        </script>
    </body>
    </html>
